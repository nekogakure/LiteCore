この章では、カーネルのメイン関数とエントリポイントについて記述します。
実装されているファイルは[main.c](../../src/kernel/main.c), [entry.c](../../src/kernel/entry.c)です。

## 概要
mainモジュールは、カーネルのメイン実行ループを提供します。システムの初期化後、イベント処理、シェルの実行、CPUの休止を繰り返し行います。entryモジュールは、ブートローダーからカーネルに制御が移る最初のCコードエントリポイントです。

## 関数 / API

### main.c

#### `void kmain(BOOT_INFO *boot_info)`
LiteCoreカーネルのメイン関数です。以下の処理を実行します：

1. ブート情報の保存
2. コンソールの初期化
3. GDTの構築とインストール
4. ウェルカムメッセージの表示
5. カーネルサブシステムの初期化（`kernel_init()`）
6. テストの実行（TEST_TRUEが定義されている場合）
7. シェルの初期化（`init_full_shell()`）
8. 割り込みの有効化（`sti`）
9. メインループ（`kloop()`）に入る

引数:
  - boot_info(BOOT_INFO*): ブートローダーから渡されるブート情報

#### `void kloop()`
カーネルのメインイベントループです。以下を繰り返し実行します：

1. キーボードのポーリング（`keyboard_poll()`）
2. 割り込みイベントの処理（`interrupt_dispatch_one()`をFIFOが空になるまで繰り返し）
3. シェルのreadlineと実行（`shell_readline_and_execute()`）
4. 何も処理がない場合、CPUを休止（`cpu_halt()`）

引数: なし

### entry.c

#### `void kernel_entry(BOOT_INFO *boot_info)`
カーネルのエントリポイントです。ブートローダーから制御を受け取り、`kmain()`を呼び出します。`.text.kernel_entry`セクションに配置されます。

引数:
  - boot_info(BOOT_INFO*): ブートローダーから渡されるブート情報

## 定数 / 定義

このファイルには定数定義はありません。

## 構造体

このファイルには公開構造体の定義はありません。

### グローバル変数

- `g_ext2_sb`: グローバルext2スーパーブロックポインタ
- `g_boot_info`: グローバルブート情報ポインタ

### 起動シーケンス

1. **ブートローダー**: GRUBなどがカーネルをロード
2. **kernel_entry()**: カーネルのCコードエントリポイント
3. **kmain()**: システムの初期化とメインループの開始
4. **kloop()**: イベント処理とシェルの実行

### イベント駆動アーキテクチャ

`kloop()`はイベント駆動方式で動作します：
- 割り込みイベントをFIFOキューから取り出して処理
- キーボード入力を処理
- 何も処理がない場合はCPUを休止して電力を節約

### 条件付きコンパイル

- `TEST_TRUE`: 定義されている場合、テストを実行

### メインループの効率化

アクティビティフラグを使用して、何も処理がなかった場合のみCPUを休止させることで、レスポンスと電力効率のバランスを取っています。
