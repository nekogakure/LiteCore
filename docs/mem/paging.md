この章では、ページング機構について記述します。
実装されているファイルは[paging.c](../../src/kernel/mem/paging.c), [paging.h](../../src/include/mem/paging.h)です。

## 概要
ページング機構は、x86の仮想メモリ管理を実装します。ページディレクトリとページテーブルを使用して、物理アドレスから仮想アドレスへのマッピングを管理します。恒等マッピング（identity mapping）の初期化、ページフォルトハンドラ、動的なページマッピング/アンマッピングをサポートします。

## 関数 / API

#### `void paging_init_identity(uint32_t map_mb)`
指定されたサイズ（MB単位）の恒等マッピングを初期化します。仮想アドレスと物理アドレスが同じになるように最初の数MBをマッピングします。

引数:
  - map_mb(uint32_t): マッピングするメモリサイズ（メガバイト）

#### `void paging_enable(void)`
ページングを有効化します。CR0レジスタのPGビットをセットし、ページディレクトリをCR3レジスタにロードします。

引数: なし

#### `void *alloc_page_table(void)`
ゼロクリアされたページテーブルを確保します。物理フレームを割り当て、仮想アドレスを返します。

引数: なし

戻り値: ページテーブルの仮想アドレス、失敗時はNULL

#### `int map_page(uint32_t phys, uint32_t virt, uint32_t flags)`
物理アドレスを仮想アドレスにマッピングします。必要に応じてページテーブルを自動的に割り当てます。

引数:
  - phys(uint32_t): 物理アドレス（4KBアライン）
  - virt(uint32_t): 仮想アドレス（4KBアライン）
  - flags(uint32_t): ページ属性フラグ（PAGING_PRESENT, PAGING_RW, PAGING_USER）

戻り値: 0=成功、-1=失敗

#### `int unmap_page(uint32_t virt)`
仮想アドレスのマッピングを解除します。TLBを無効化します。

引数:
  - virt(uint32_t): 仮想アドレス

戻り値: 0=成功、-1=失敗

#### `int map_range(uint32_t phys_start, uint32_t virt_start, size_t size, uint32_t flags)`
連続した物理メモリ範囲を仮想メモリ範囲にマッピングします。

引数:
  - phys_start(uint32_t): 物理アドレスの開始位置
  - virt_start(uint32_t): 仮想アドレスの開始位置
  - size(size_t): マッピングするサイズ（バイト）
  - flags(uint32_t): ページ属性フラグ

戻り値: 0=成功、-1=失敗

#### `void page_fault_handler_ex(uint32_t vec, uint32_t error_code, uint32_t eip)`
ページフォルト例外ハンドラです。ページフォルトが発生した時に呼び出されます。

引数:
  - vec(uint32_t): 例外ベクタ番号（14）
  - error_code(uint32_t): エラーコード
  - eip(uint32_t): ページフォルトが発生した命令ポインタ

## 定数 / 定義

- `PAGING_PRESENT`: 0x1 - ページが存在する（このフラグがないとページフォルトが発生）
- `PAGING_RW`: 0x2 - 読み書き可能（このフラグがないと読み取り専用）
- `PAGING_USER`: 0x4 - ユーザーモードからアクセス可能（このフラグがないとカーネルモードのみ）

これらのフラグはビット OR で組み合わせて使用できます：`PAGING_PRESENT | PAGING_RW | PAGING_USER`

## 構造体

このファイルには公開構造体の定義はありません。

### 内部実装

- `page_directory[1024]`: ページディレクトリ（4KBアライン）
- `first_table[1024]`: 最初の4MBの恒等マッピング用テーブル（4KBアライン）

### ページディレクトリとページテーブル

- **ページディレクトリ**: 1024エントリ、各エントリは4MBの仮想アドレス空間を管理
- **ページテーブル**: 1024エントリ、各エントリは4KBのページを管理
- **仮想アドレス構成**:
  - ビット31-22: ページディレクトリインデックス（10ビット）
  - ビット21-12: ページテーブルインデックス（10ビット）
  - ビット11-0: ページ内オフセット（12ビット）

### TLB管理

- `invlpg`命令を使用して単一ページのTLBエントリを無効化
- ページマッピング変更後にTLBを更新
