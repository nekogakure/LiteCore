この章では、キーボードドライバについて記述します。
実装されているファイルは[keyboard.c](../../src/kernel/device/keyboard.c), [keyboard.h](../../src/include/device/keyboard.h)です。

## 概要
キーボードドライバは、PS/2キーボードからの入力を処理し、文字バッファを管理します。スキャンコードをASCII文字に変換し、Shift、Ctrl、Altキーの状態を管理します。リングバッファを使用して入力をバッファリングし、ブロッキング/ノンブロッキングの読み取りをサポートします。

## 関数 / API

#### `void keyboard_init(void)`
キーボードドライバを初期化します。割り込みハンドラを登録し、キーボードからの入力を処理できる状態にします。

引数: なし

#### `void keyboard_poll(void)`
キーボード入力をポーリングします（非ブロッキング）。ISRを手動で呼び出してキーボードデータポートをチェックします。

引数: なし

#### `char keyboard_getchar(void)`
キーボードから1文字を取得します（ブロッキング）。バッファが空の場合、文字が入力されるまで待機します。

引数: なし

戻り値: 取得した文字

#### `char keyboard_getchar_poll(void)`
キーボードから1文字を取得します（ノンブロッキング）。バッファが空の場合は0を返します。

引数: なし

戻り値: 取得した文字、バッファが空の場合は0

## 定数 / 定義

- `KEY_BUFFER_SIZE`: 256 - キーボード入力バッファのサイズ（バイト）
- `KBD_DATA_PORT`: 0x60 - キーボードデータポート
- `KBD_EVENT(irq, sc)`: IRQ番号とスキャンコードをエンコードするマクロ

## 構造体

このファイルには公開構造体の定義はありません。内部的にはリングバッファとスキャンコードマップを使用しています。

### 内部実装

- `key_buffer[]`: 文字を格納するリングバッファ（256バイト）
- `buffer_read_pos`: バッファの読み取り位置
- `buffer_write_pos`: バッファの書き込み位置
- `scancode_map[]`: 通常のスキャンコードからASCII文字へのマッピング
- `scancode_map_shift[]`: Shiftキー押下時のスキャンコードマッピング

### キー処理

- **Shift/Ctrl/Altキー**: 状態を内部変数で管理
- **通常キー**: スキャンコードマップを使用してASCII文字に変換
- **制御文字**: Ctrl+キーは "^" プレフィックス付きでバッファに格納
- **Altキー**: 画面に表示するがバッファには追加しない
